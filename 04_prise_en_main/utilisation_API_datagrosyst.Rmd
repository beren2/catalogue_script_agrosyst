---
title: "utilisation_API_datagrosyst"
author: "Thomas BADIE"
date: "2025-12-08"
output: html_document
---

# Utilisation de l'API Datagrosyst (R)

Le but de ce code est d'utiliser l'API de Datagrosyst afin de g√©n√©rer une requ√®te de t√©l√©chargement des tables que vous indiquerez au pr√©alable. Celui-ci va permettre de recevoir le mail avec le lien Filesender de t√©l√©chargement. L'√©tape de t√©l√©chargement via le filesender n'est pas automatiser, il faudra aller manuellement dans votre boite et mail, cliquer sur le lien et t√©l√©charger.

Nous allons √©galement vous faire une code qui ira chercher dans votre dossier de t√©l√©chargement le fichier Filesender, pour le d√©compr√©ss√© et le stocker dans un autre dossier (votre dossier de travail).

Ensuite, un dernier bout de code afin d'importer les tables que vous venez de t√©l√©charger.

## Import des librairies

```{r, include = FALSE}
library(httr)
library(dplyr)
library(TAR)
```

## Initialisation de la requ√®te et des chemins de dossier

<font color="#900000">Attention</font>  aux noms des tables !  
Les cha√Ænes de caract√®res permettant d‚Äôidentifier les tables dans le champ **"tables"** sont celles qui sont disponibles dans le volet √† droite sur Datagrosyst. Celles-ci diff√®rent parfois du nom disponible sur l‚Äôinterface de s√©lection. Par exemple, dans le magasin_can, lorsqu‚Äôon s√©lectionne *‚Äúdomaine‚Äù*, on voit appara√Ætre √† droite *‚Äúdomaine_magasin_can‚Äù*. C‚Äôest ce dernier libell√© qu‚Äôil faut saisir dans le champ **"tables"** pour obtenir table domaine du magasin_can, car saisir simplement *‚Äúdomaine‚Äù* ferait r√©f√©rence √† la table domaine de l‚Äôentrep√¥t.


<font color="#900000">Attention</font> aux restrictions d'acc√®s aux donn√©es !  
Si vous saisissez dans **‚Äútables‚Äù** des noms de tables pour lesquelles vous n‚Äôavez pas les droits, celles-ci ne seront pas ajout√©es dans l‚Äôexport obtenu.

Le <font color="green">token de l'API</font> est en quelque sorte un mot de passe, ne pas le transmettre !  
Vous le trouverez dans [üîó votre profil](https://agrosyst.fr/datagrosyst/profil) sur Datagrosyst, au dessus des param√®tres.



```{r}
url <- "https://agrosyst.fr/datagrosyst/export"

# La liste des tables √† r√©cup√©rer
tables <- c("domaine", "parcelle") # √Ä modifier

# La structure de la requ√™te
# Modifier "mail" et "token" avec vos informations personnelles disponibles dans le profil de votre compte Datagrosyst
data_request <- list(
  mail = "votreadressemail@exemple.fr",      # √Ä modifier
  token = "tokendiponiblesurDatagrosyst",    # √Ä modifier
  tables = tables
)

# Les chemins vers vos dossiers locaux
path_download <- "/chemin/vers/ton/dossier/de/T√©l√©chargements"       # Modifier ici le chemin vers votre dossier de t√©l√©chargements
path_workdirectory <- "/chemin/vers/ton/Workdirectory"               # Modifier ici le chemin vers votre dossier de travail
```

## Envoy√© la demande √† Datagrosyst grace √† `httr`

```{r}
# Envoi de la requ√™te POST √† l'API Datagrosyst
response <- POST(url, body = data_request, encode = "json")

# Code de v√©rification de la r√©ponse de l'API
if (http_status(response)$category == "Success") {
  print("Requ√™te r√©ussie !")
} else {
  print(paste("Erreur lors de la requ√™te. Code d'√©tat :", http_status(response)$message))
  print(paste("R√©ponse :", content(response, "text")))
}
```

```{r}
stop("Vous avez termin√© la phase de demande des donn√©es via API, F√©licitations !\nPour continuer, il vous faut d√©sormais faire l'√©tape manuelle de t√©l√©chargement des donn√©es\n(lien Filesender dans votre boite mail ; voir 'T√©l√©charger les donn√©es').")
```

## T√©l√©charger les donn√©es

**<font color="#900000">Attention cette √©tape est manuelle !</font>**  
Vous aller recevoir un mail de la part de Filesender vous invitant √† aller t√©l√©charger les donn√©es stock√©es pour vous via un lien. Cliquez sur ce lien, puis t√©l√©charger le fichier compr√©ss√©. Ce fichier va noramlement se retrouver directement dans votre dossier de t√©l√©chargement **path_download**.


## D√©placer et d√©compr√©ss√© le fichier Filesender t√©l√©charg√©

Vous avez d√©sormais le fichier compr√©ss√© dans votre dossier de t√©l√©chargement. Avec le code propos√© ci-dessous, vous aller en plusieurs √©tapes : 
- **Trouver le fichier .tar.gz** (extension des fichiers compr√©ss√©s) *le plus r√©cent* de votre dossier de t√©l√©chargement
- **Copier** ce fichier vers votre dossier de travail
- **D√©compr√©ss√©** le fichier, ce qui va automatiquement √©craser les anciennes tables pour mettre les nouvelles tables (celles pr√©sentes dans le fichier compr√©ss√©, que vous avez d√©fini lors de l'initialisation)
- **Supprim√©** le fichier compr√©ss√© pour ne gard√© que les tables

```{r}
# Trouver le fichier .tar.gz le plus r√©cent du dossier de t√©l√©chargements
tar_files <- list.files(path_download, pattern = ".tar.gz", full.names = TRUE)
if (length(tar_files) == 0) {
  stop("Aucun fichier .tar.gz trouv√©.")
}

latest_file <- tar_files[which.max(file.info(tar_files)$mtime)]
file_mtime <- as.Date(file.info(latest_file)$mtime)

if (file_mtime != Sys.Date()) {
  stop(paste("Le fichier le plus r√©cent (", latest_file, ") n'a pas √©t√© modifi√© aujourd'hui.", sep = ""))
}

print(paste("Fichier le plus r√©cent :", latest_file))

# Copier le fichier compress√© vers le dossier de travail
if (!dir.exists(path_workdirectory)) {
  dir.create(path_workdirectory, recursive = TRUE)
}
dest_tar_path <- file.path(path_workdirectory, basename(latest_file))
invisible(file.copy(latest_file, dest_tar_path))

# D√©compresser (√©crase automatiquement les fichiers existants, c'est-√†-dire les plus anciens)
untar(dest_tar_path, exdir = path_workdirectory)

# Supprime le fichier compress√© dans le dossier de travail apr√®s d√©compression
invisible(file.remove(dest_tar_path))

# Fin
print(paste("D√©compression termin√©e dans", path_workdirectory))
```

## Chargement des donn√©es dans le Notebook

Vous voici avec les tables de donn√©es nouvellement acquise dans votre dossier de travail !  
Maintenant nous allons les importer dans le Notebook. Pour cela nous allons d√©finir un dictionnaire de table dont le nom sera le nom du fichier. Nous pr√©parons aussi une fonction d'import d'une table qui sera reprise par la fonction d'import de plusieurs tables. Nous utilisons ensuite cette derni√®re fonction en sp√©cifiant les **tables** que vous venez de t√©l√©charg√©es (pas toutes celle du dossier de travail !) et le chemin vers le dossier de travail.

```{r}
# Liste pour stocker les tables (nomm√©e par le nom des fichiers)
tables_list <- list()

# Fonction d'import d'une table
import_table <- function(name, path) {
  file <- file.path(path, paste0(name, ".csv"))
  if (file.exists(file)) {
    tables_list[[name]] <<- read.csv(file, sep = ",", header = TRUE)
  }
}

# Import des tables
invisible(sapply(tables, import_table, path = path_workdirectory))
# table g√©n√©rale contenant les tables domaine et parcelles : tables_list

# R√©sum√© des 5 premi√®res tables
for (name in names(tables_list)[1:min(5, length(tables_list))]) {
  tbl <- tables_list[[name]]
  cat("\n---", name, "---\n")
  cat("Lignes:", nrow(tbl), "| Colonnes:", ncol(tbl), "\n")
  cat("Colonnes :", paste(names(tbl), collapse = ", "), "\n")
}
```

# Fin
